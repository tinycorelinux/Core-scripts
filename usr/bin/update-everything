#!/bin/busybox ash

# update-everything v9.0 (December 21, 2023)
# by Bruno "GNUser" Dantas, with special thanks to jazzbiker, Rich, Paul_123
# GPLv3

# Purpose: Do a full TCL system update as quickly and efficiently as possible, leaving custom extensions intact 
# Usage: $ update-everything

PATH="/bin:/sbin:/usr/bin:/usr/sbin"
export PATH

main()
{
	rm -rf "$TMPDIR"; mkdir "$TMPDIR"; cd "$TMPDIR"
	. /etc/init.d/tc-functions
	getMirror

	echo "Downloading and preparing databases..."
	get "$DEPDBGZ"; extract "$DEPDBGZ"; sanity_check "$DEPDB"
	get "$MD5DBGZ"; extract "$MD5DBGZ"; sanity_check "$MD5DB"
	generate_dep_files

	echo "Syncing .dep files..."
	fix_missing_and_extraneous_dep_files
	update_dep_files

	if $DEP_FILES_CHANGED; then
		echo "Building package database..."
		tce-audit builddb
		echo "Looking for missing dependencies..."
		tce-audit fetchmissing
	fi

	echo "Updating extensions..."
	tce-update --skip-dependency-check

	cleanup
	exit 0
}

get()
{
	if ! wget -q "$MIRROR"/"$1"; then
		echo "Download of $1 failed. Aborting."
		exit 1
	fi
}

extract()
{
	if ! gunzip -kf "$1"; then
		echo "Error extracting $1. Aborting."
		exit 1
	fi
}

sanity_check()
{
	if ! grep -q "zstd.tcz" "$1"; then
		echo "$1 failed sanity check. Aborting."
		exit 1
	fi
}

generate_dep_files()
{
	mkdir "$DEPDIR"
	cp "$TMPDIR/$DEPDB" "$DEPDIR"
	cd "$DEPDIR"
	awk 'BEGIN {FS="\n";RS=""} { out=$1".dep"; for (i=2; i<=NF; i++) printf("%s\n", $(i)) >out; close(out) }' dep.db
}

fix_missing_and_extraneous_dep_files()
{
	for md5file in $(find -L $OPTIONALDIR -name '*.md5.txt' -exec basename {} \;); do
		depfile="${md5file%.md5.txt}.dep" # i.e., foo.tcz.dep
		tczname="${md5file%.md5.txt}" # i.e., foo.tcz
		if [ -f $DEPDIR/$depfile ] && [ ! -f $OPTIONALDIR/$depfile ]; then
			echo "$depfile is missing, adding it..."
			cp $DEPDIR/$depfile $OPTIONALDIR
			DEP_FILES_CHANGED=true
		elif [ ! -f $DEPDIR/$depfile ] && [ -f $OPTIONALDIR/$depfile ] && grep -q " $tczname" /tmp/md5.db; then
			echo "$depfile is extraneous, removing it..."
			rm $OPTIONALDIR/$depfile
		fi
	done
}

update_dep_files()
{
	for md5file in $(find -L $OPTIONALDIR -name '*.md5.txt' -exec basename {} \;); do
		depfile="${md5file%.md5.txt}.dep"
		if [ ! -f $OPTIONALDIR/$depfile ]; then # extension does not have a dep file
			continue
		# echo is used in the comparison to eat whitespace (e.g., trailing spaces and blank lines):
		elif [ "$(echo $(cat $OPTIONALDIR/$depfile))" = "$(echo $(cat $DEPDIR/$depfile))" ]; then
			continue
		else
			echo "$depfile has changed, updating it..."
			cp $DEPDIR/$depfile $OPTIONALDIR
			DEP_FILES_CHANGED=true
		fi
	done
}

cleanup()
{
	cd /tmp
	rm -rf "$TMPDIR"
}

# internal variables, do not touch:
OPTIONALDIR="/etc/sysconfig/tcedir/optional"
TMPDIR="/tmp/update-everything"
DEPDIR="$TMPDIR/depfiles"
DEPDB="dep.db"
DEPDBGZ="$DEPDB.gz"
MD5DB="md5.db"
MD5DBGZ="$MD5DB.gz"
DEP_FILES_CHANGED=false

main
